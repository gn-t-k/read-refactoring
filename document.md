# 「リファクタリング」まとめ

## 第2章_リファクタリングの原則

### リファクタリングの定義

| 定義 | 意味 |
| - | - |
|リファクタリング（名詞） | 外部から見たときの振る舞いを保ちつつ、理解や修正が簡単になるように、ソフトウェアの内部構造を変化させること。 |
| リファクタリングする（動詞） | 一連のリファクタリングを適用して、外部から見た振る舞いの変更なしに、ソフトウェアを再構築すること |

- 「リファクタリングする」ために時間を費やすことがあるが、その中には多数の「リファクタリング」が含まれている。
- 個々の「リファクタリング」は小さなものであるべきなので、コードが壊れたままになっている時間は短くなるべきである。
- リファクタリング（動詞）が未完了であっても、いつでも中断が可能であるべきである。
- 外部から見た振る舞いが変更されてなければよいので、リファクタリングによってモジュールのインターフェイスが変化することはある。
- リファクタリングの途中で見つけたバグは、リファクタリング後も残っているべきである。

### 2つの帽子

コーディング時に行う作業は、「機能追加のための作業」と「リファクタリングのための作業」との2つの活動に区分されるべきである。Kent Beckは、これを「2つの帽子を交互にかぶる」と例えた。コーディング時は、自分がどちらの帽子をかぶっているのかを常に意識するべきであるという意味。

#### 機能追加のための作業

- 機能追加の帽子をかぶっているときは、既存のコードを変更してはいけない。
- 単純に機能を拡張することに専念する。

#### リファクタリングのための作業

- リファクタリングの帽子をかぶっているときは、機能追加は行わず、コードを再構築するのみ。
- テストの追加をしてはいけない（テストケースが漏れていた場合は例外）。

### リファクタリングを行う理由

#### リファクタリングはソフトウェア設計を改善する

以下のような過程で、リファクタリングされないコードは劣化していくため、リファクタリングは定期的に行われるべきである。

1. 開発者が、短期的な目的の実現のために、設計を把握せずに変更を行う。
2. コードは構造を失う。
3. 設計がより把握しづらくなる。
4. 1〜3の悪循環が起こり、コードは急速に劣化していく

設計を把握しやすい状態にしておくべき理由は、以下の通り。

- 設計が把握しづらいコードは、処理の重複が増える。
- 重複した処理が点在している場合、修正が大変になる。

#### リファクタリングはソフトウェアを理解しやすくする

以下の理由により、ソフトウェアは理解しやすくするべきである。

- コードは書いて終わりではなく、その後の保守がある。
- 機能追加時にわかりにくいコードを理解するためにかかる時間は、コンピューターがデータを処理するのにかかる時間よりはるかに長い。

定期的にリファクタリングが行われているコードは、処理の重複が無く、構造化されているため、ソフトウェアが理解しやすい。

#### リファクタリングはバグの発見を助ける

理解しやすいコードは、バグも見つけやすい。リファクタリングはソフトウェアを理解しやすくするので、バグも発見しやすくなる。

#### リファクタリングはプログラミングを速める

以下の理由により、リファクタリングはプログラミングを速める。

- 定期的にリファクタリングが行われているコードは理解しやすいため、機能追加時にコードを読み込む時間が短くなり、短時間で機能を追加することができる。
- 定期的にリファクタリングが行われているコードはバグを埋め込みにくく、デバッグが簡単であるため、バグの修正にとられる時間が短くなる。

### いつリファクタリングをすべきか

#### 準備のためのリファクタリング -- 機能追加を容易にするために

機能追加時に「もし構造が少し違っていたら作業はずっと簡単になるだろう」と思ったタイミングで、構造を変えるためのリファクタリングをする。

たとえば、ある機能を追加しようとしたとき、要求を「ほぼ」満たしている関数がすでにあった時。その関数をコピーしてわずかに修正しただけの関数を作ってしまうと、処理の重複が発生してしまう。また、そういった処理は、将来的にさらにバリエーションが増える可能性もある。「パラメーターによる関数の統合」などを行うことで、処理の重複を避け、将来的な機能の追加を容易にすることができる。

バグ修正時も、機能追加時と同様である。バグを修正する前にリファクタリングを行うことで、そのときのバグ修正が容易になるだけではなく、将来的に似たようなバグが出にくくなる。

#### 理解のためのリファクタリング -- コードをわかりやすくするために

既存のコードを読み込む時、以下のようなリファクタリングを行う。

- 何を表すのか理解しやすいように変数名を変更する。
- 長い関数を短い関数に分割する

リファクタリングのために行う調査がソフトウェアに対する理解を助け、さらにリファクタリング以降のコードが読みやすくなる。

#### ゴミ拾いのためのリファクタリング

「来たときよりも美しく」の精神で、ダメなコードを見るたびに少しずつきれいにしていく。

#### 計画されたリファクタリングと、機に応じたリファクタリング

- あらかじめリファクタリング用に時間を確保しておくのではなく、機能追加やバグ修正の最中にリファクタリングを行う。
- 加えられる新機能によっては、素晴らしいコードもリファクタリングすることがある。
- 新機能追加とリファクタリングをバージョン管理システム上で別コミットにしたほうがよいという意見があるが、リファクタリングのコンテキストがわからなくなることもある。

#### 長期のリファクタリング

- 既存のライブラリの置き換えや、既存のシステムの一部をコンポーネント化して公開したい場合など、長期間に渡って行われるリファクタリングもある。
- リファクタリングに専念するのではなく、できるだけ小さなステップでリファクタリングを進めることによって、リファクタリングがコードを壊さないという利点を活かすことができる。

#### コードレビュー時のリファクタリング

- コードレビュー時にリファクタリングできないかどうか考えることで、機能を実装することしか考えなかったときより一歩進んだアイデアが生まれる。
- コードレビュー時にリファクタリングを提案することで、単に意見が出るだけではなく多くの意見が実装される。

#### 管理者を説得するには

- コードベースを壊しかねない無防備な再構築（リファクタリングとは呼べない）をしているチームは、管理者にリファクタリングの価値をわかってもらえるような成果を上げにくい
- コードの健康状態がのちの生産性にどれほど影響を与えるか管理者が理解できていない場合は、黙ってリファクタリングしてしまっても構わない
- リファクタリングは、生産的に機能を実装するための技術のひとつ。

#### リファクタリングを避けるとき

- どのようにして動いているのか理解する必要がない単なるAPIなどであれば、汚いコードであっても放置しておいてよい。
- リファクタリングするより最初から書き直したほうがいいこともあるが、見極めには適切な判断能力と豊富な経験が必要になる。

### リファクタリングの問題点

#### 新機能の実装が遅くなる

#### コードの所有権

#### ブランチ

#### テスト

#### レガシーコード

#### データベース

### リファクタリングとアーキテクチャ、そしてYagni

### リファクタリングとソフトウェア開発プロセス

### リファクタリングとパフォーマンス

### リファクタリングの起源

### 自動化されたリファクタリング

### さらに興味のある方へ
